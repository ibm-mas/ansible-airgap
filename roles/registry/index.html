<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://ibm-mas.github.io/ansible-airgap/roles/registry/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>registry - MAS Airgap Collection</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "registry";
        var mkdocs_page_input_path = "roles/registry.md";
        var mkdocs_page_url = "/ansible-airgap/roles/registry/";
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> MAS Airgap Collection
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../changes/">Changes</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Roles</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../case_mirror/">case_mirror</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../case_prepare/">case_prepare</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../catalogs/">catalogs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../ocp_contentsourcepolicy/">ocp_contentsourcepolicy</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">registry</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#usage">Usage</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#role-variables">Role Variables</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#registry_namespace">registry_namespace</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#registry_storage_class">registry_storage_class</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#registry_storage_capacity">registry_storage_capacity</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#registry_service_type">registry_service_type</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#example-playbook">Example Playbook</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#license">License</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../thirdparty_mirror/">thirdparty_mirror</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">MAS Airgap Collection</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Roles &raquo;</li>
      <li>registry</li>
    <li class="wy-breadcrumbs-aside">
        <a href="https://github.com/ibm-mas/ansible-airgap/blob/master/docs/roles/registry.md"
          class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="registry">registry<a class="headerlink" href="#registry" title="Permanent link"></a></h1>
<p>Create a Docker Registry running on RedHat OpenShift cluster.  The registry will be backed by persistant storage, and accessible via either a clusterIP or loadbalancer service.</p>
<h2 id="usage">Usage<a class="headerlink" href="#usage" title="Permanent link"></a></h2>
<p>If you set up the registry with a <strong>loadbalancer</strong> service you will be able to push to the registry via the cluster's hostname, but before you can use the registry you will need to install the registry's CA certificate and restart the Docker daemon so that your client trusts the new registry:</p>
<pre><code class="language-bash">CACERT=$(oc -n airgap-registry get secret airgap-registry-certificate -o jsonpath='{.data.ca\.crt}' | base64 -d)
DOMAIN=$(oc get ingress.config cluster -o jsonpath='{.spec.domain}')
sudo mkdir -p /etc/docker/certs.d/$DOMAIN\:32500/
sudo echo &quot;$CACERT&quot; &gt; /etc/docker/certs.d/$DOMAIN\:32500/ca.crt
sudo service docker restart
</code></pre>
<p>You can now use the registry as normal:</p>
<pre><code class="language-bash">DOMAIN=$(oc get ingress.config cluster -o jsonpath='{.spec.domain}')
docker pull registry.access.redhat.com/ubi8/ubi-minimal
docker tag registry.access.redhat.com/ubi8/ubi-minimal $DOMAIN:32500/ubi8/ubi-minimal
docker push $DOMAIN:32500/ubi8/ubi-minimal
</code></pre>
<p>If you set up the registry with a <strong>clusterip</strong> service you will only be able to push to the registry after using port forwarding:</p>
<pre><code class="language-bash">oc -n airgap-registry port-forward deployment/airgap-registry 9000:5000

docker pull registry.access.redhat.com/ubi8/ubi-minimal
docker tag registry.access.redhat.com/ubi8/ubi-minimal localhost:9000/ubi8/ubi-minimal
docker push localhost:9000/ubi8/ubi-minimal
</code></pre>
<p>However, you will still need to set up Docker trust for the "local" registry:</p>
<pre><code class="language-bash">CACERT=$(oc -n airgap-registry get secret airgap-registry-certificate -o jsonpath='{.data.ca\.crt}' | base64 -d)
sudo mkdir -p /etc/docker/certs.d/$DOMAIN\:32500/
sudo mkdir /etc/docker/certs.d/localhost\:9000
sudo echo &quot;$CACERT&quot; &gt; /etc/docker/certs.d/localhost\:9000/ca.crt
sudo service docker restart
</code></pre>
<h2 id="role-variables">Role Variables<a class="headerlink" href="#role-variables" title="Permanent link"></a></h2>
<h3 id="registry_namespace">registry_namespace<a class="headerlink" href="#registry_namespace" title="Permanent link"></a></h3>
<p>The namespace where the registry to run</p>
<ul>
<li>Optional</li>
<li>Environment Variable: <code>REGISTRY_NAMESPACE</code></li>
<li>Default Value: <code>airgap-registry</code></li>
</ul>
<h3 id="registry_storage_class">registry_storage_class<a class="headerlink" href="#registry_storage_class" title="Permanent link"></a></h3>
<p>Required.  The name of the storage class to configure the MongoDb operator to use for persistent storage in the MongoDb cluster.</p>
<ul>
<li><strong>Required</strong>, unless running in IBM Cloud ROKS, where the storage class will default to <code>ibmc-block-gold</code>.</li>
<li>Environment Variable: <code>REGISTRY_STORAGE_CLASS</code></li>
<li>Default Value: None</li>
</ul>
<h3 id="registry_storage_capacity">registry_storage_capacity<a class="headerlink" href="#registry_storage_capacity" title="Permanent link"></a></h3>
<p>The size of the PVC that will be created for data storage in the cluster.</p>
<ul>
<li>Optional</li>
<li>Environment Variable: <code>REGISTRY_STORAGE_CAPACITY</code></li>
<li>Default Value: <code>100Gi</code></li>
</ul>
<h3 id="registry_service_type">registry_service_type<a class="headerlink" href="#registry_service_type" title="Permanent link"></a></h3>
<p>The type of service to set up in front of the registry, either <code>loadbalancer</code> or <code>clusterip</code>.  Using <code>loadbalancer</code> will allow you to access the registry from outside of your cluster via the cluster domain on port <code>32500</code>.  If you have other loadbalancers on the cluster that already claim port <code>32500</code> this role can not be usedbecause currently the loadbalancer port can not be customised.</p>
<ul>
<li>Optional</li>
<li>Environment Variable: <code>REGISTRY_SERVICE_TYPE</code></li>
<li>Default Value: <code>loadbalancer</code></li>
</ul>
<h2 id="example-playbook">Example Playbook<a class="headerlink" href="#example-playbook" title="Permanent link"></a></h2>
<pre><code class="language-yaml">- hosts: localhost
  any_errors_fatal: true
  vars:
    registry_storage_class: ibmc-block-gold
    registry_storage_capacity: 500Gb
    registry_service_type: loadbalancer
  roles:
    - ibm.mas_airgap.registry
</code></pre>
<h2 id="license">License<a class="headerlink" href="#license" title="Permanent link"></a></h2>
<p>EPL-2.0</p>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/ibm-mas/ansible-airgap" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../ocp_contentsourcepolicy/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../thirdparty_mirror/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
